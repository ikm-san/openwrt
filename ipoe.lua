local fs = require "nixio.fs"
local sys = require "luci.sys"
local uci = require "luci.model.uci".cursor()

-- IPv6からIPv4プレフックスへの変換マップ based on http://ipv4.web.fc2.com/map-e.html
local ruleprefix31 = {
    ["240b0010"] = "106.72",
    ["240b0012"] = "14.8",
    ["240b0250"] = "14.10",
    ["240b0252"] = "14.12",
    ["24047a80"] = "133.200",
    ["24047a84"] = "133.206"
}

local ruleprefix38 = {
    ["24047a8200"] = "125.196.208",
    ["24047a8204"] = "125.196.212",
    ["24047a8208"] = "125.198.140",
    ["24047a820c"] = "125.198.144",
    ["24047a8210"] = "125.198.212",
    ["24047a8214"] = "125.198.244",
    ["24047a8218"] = "122.131.104",
    ["24047a821c"] = "125.195.20",
    ["24047a8220"] = "133.203.160",
    ["24047a8224"] = "133.203.164",
    ["24047a8228"] = "133.203.168",
    ["24047a822c"] = "133.203.172",
    ["24047a8230"] = "133.203.176",
    ["24047a8234"] = "133.203.180",
    ["24047a8238"] = "133.203.184",
    ["24047a823c"] = "133.203.188",
    ["24047a8240"] = "133.209.0",
    ["24047a8244"] = "133.209.4",
    ["24047a8248"] = "133.209.8",
    ["24047a824c"] = "133.209.12",
    ["24047a8250"] = "133.209.16",
    ["24047a8254"] = "133.209.20",
    ["24047a8258"] = "133.209.24",
    ["24047a825c"] = "133.209.28",
    ["24047a8260"] = "133.204.192",
    ["24047a8264"] = "133.204.196",
    ["24047a8268"] = "133.204.200",
    ["24047a826c"] = "133.204.204",
    ["24047a8270"] = "133.204.208",
    ["24047a8274"] = "133.204.212",
    ["24047a8278"] = "133.204.216",
    ["24047a827c"] = "133.204.220",
    ["24047a8280"] = "133.203.224",
    ["24047a8284"] = "133.203.228",
    ["24047a8288"] = "133.203.232",
    ["24047a828c"] = "133.203.236",
    ["24047a8290"] = "133.203.240",
    ["24047a8294"] = "133.203.244",
    ["24047a8298"] = "133.203.248",
    ["24047a829c"] = "133.203.252",
    ["24047a82a0"] = "125.194.192",
    ["24047a82a4"] = "125.194.196",
    ["24047a82a8"] = "125.194.200",
    ["24047a82ac"] = "125.194.204",
    ["24047a82b0"] = "119.239.128",
    ["24047a82b4"] = "119.239.132",
    ["24047a82b8"] = "119.239.136",
    ["24047a82bc"] = "119.239.140",
    ["24047a82c0"] = "125.194.32",
    ["24047a82c4"] = "125.194.36",
    ["24047a82c8"] = "125.194.40",
    ["24047a82cc"] = "125.194.44",
    ["24047a82d0"] = "125.195.24",
    ["24047a82d4"] = "125.195.28",
    ["24047a82d8"] = "122.130.192",
    ["24047a82dc"] = "122.130.196",
    ["24047a82e0"] = "122.135.64",
    ["24047a82e4"] = "122.135.68",
    ["24047a82e8"] = "125.192.240",
    ["24047a82ec"] = "125.192.244",
    ["24047a82f0"] = "125.193.176",
    ["24047a82f4"] = "125.193.180",
    ["24047a82f8"] = "122.130.176",
    ["24047a82fc"] = "122.130.180",
    ["24047a8300"] = "122.131.24",
    ["24047a8304"] = "122.131.28",
    ["24047a8308"] = "122.131.32",
    ["24047a830c"] = "122.131.36",
    ["24047a8310"] = "119.243.112",
    ["24047a8314"] = "119.243.116",
    ["24047a8318"] = "219.107.136",
    ["24047a831c"] = "219.107.140",
    ["24047a8320"] = "220.144.224",
    ["24047a8324"] = "220.144.228",
    ["24047a8328"] = "125.194.64",
    ["24047a832c"] = "125.194.68",
    ["24047a8330"] = "221.171.40",
    ["24047a8334"] = "221.171.44",
    ["24047a8338"] = "110.233.80",
    ["24047a833c"] = "110.233.84",
    ["24047a8340"] = "119.241.184",
    ["24047a8344"] = "119.241.188",
    ["24047a8348"] = "119.243.56",
    ["24047a834c"] = "119.243.60",
    ["24047a8350"] = "125.199.8",
    ["24047a8354"] = "125.199.12",
    ["24047a8358"] = "125.196.96",
    ["24047a835c"] = "125.196.100",
    ["24047a8360"] = "122.130.104",
    ["24047a8364"] = "122.130.108",
    ["24047a8368"] = "122.130.112",
    ["24047a836c"] = "122.130.116",
    ["24047a8370"] = "49.129.152",
    ["24047a8374"] = "49.129.156",
    ["24047a8378"] = "49.129.192",
    ["24047a837c"] = "49.129.196",
    ["24047a8380"] = "49.129.120",
    ["24047a8384"] = "49.129.124",
    ["24047a8388"] = "221.170.40",
    ["24047a838c"] = "221.170.44",
    ["24047a8390"] = "60.239.108",
    ["24047a8394"] = "60.236.24",
    ["24047a8398"] = "122.130.120",
    ["24047a839c"] = "60.236.84",
    ["24047a83a0"] = "60.239.180",
    ["24047a83a4"] = "60.239.184",
    ["24047a83a8"] = "118.110.136",
    ["24047a83ac"] = "119.242.136",
    ["24047a83b0"] = "60.238.188",
    ["24047a83b4"] = "60.238.204",
    ["24047a83b8"] = "122.134.52",
    ["24047a83bc"] = "119.244.60",
    ["24047a83c0"] = "119.243.100",
    ["24047a83c4"] = "221.170.236",
    ["24047a83c8"] = "221.171.48",
    ["24047a83cc"] = "60.238.36",
    ["24047a83d0"] = "125.195.236",
    ["24047a83d4"] = "60.236.20",
    ["24047a83d8"] = "118.108.76",
    ["24047a83dc"] = "118.110.108",
    ["24047a83e0"] = "118.110.112",
    ["24047a83e4"] = "118.111.88",
    ["24047a83e8"] = "118.111.228",
    ["24047a83ec"] = "118.111.236",
    ["24047a83f0"] = "119.241.148",
    ["24047a83f4"] = "119.242.124",
    ["24047a83f8"] = "125.194.28",
    ["24047a83fc"] = "125.194.96",
    ["24047a8600"] = "133.204.128",
    ["24047a8604"] = "133.204.132",
    ["24047a8608"] = "133.204.136",
    ["24047a860c"] = "133.204.140",
    ["24047a8610"] = "133.204.144",
    ["24047a8614"] = "133.204.148",
    ["24047a8618"] = "133.204.152",
    ["24047a861c"] = "133.204.156",
    ["24047a8620"] = "133.204.160",
    ["24047a8624"] = "133.204.164",
    ["24047a8628"] = "133.204.168",
    ["24047a862c"] = "133.204.172",
    ["24047a8630"] = "133.204.176",
    ["24047a8634"] = "133.204.180",
    ["24047a8638"] = "133.204.184",
    ["24047a863c"] = "133.204.188",
    ["24047a8640"] = "133.203.192",
    ["24047a8644"] = "133.203.196",
    ["24047a8648"] = "133.203.200",
    ["24047a864c"] = "133.203.204",
    ["24047a8650"] = "133.203.208",
    ["24047a8654"] = "133.203.212",
    ["24047a8658"] = "133.203.216",
    ["24047a865c"] = "133.203.220",
    ["24047a8660"] = "133.204.0",
    ["24047a8664"] = "133.204.4",
    ["24047a8668"] = "133.204.8",
    ["24047a866c"] = "133.204.12",
    ["24047a8670"] = "133.204.16",
    ["24047a8674"] = "133.204.20",
    ["24047a8678"] = "133.204.24",
    ["24047a867c"] = "133.204.28",
    ["24047a8680"] = "133.204.64",
    ["24047a8684"] = "133.204.68",
    ["24047a8688"] = "133.204.72",
    ["24047a868c"] = "133.204.76",
    ["24047a8690"] = "133.204.80",
    ["24047a8694"] = "133.204.84",
    ["24047a8698"] = "133.204.88",
    ["24047a869c"] = "133.204.92",
    ["24047a86a0"] = "221.171.112",
    ["24047a86a4"] = "221.171.116",
    ["24047a86a8"] = "221.171.120",
    ["24047a86ac"] = "221.171.124",
    ["24047a86b0"] = "125.195.184",
    ["24047a86b4"] = "125.196.216",
    ["24047a86b8"] = "221.171.108",
    ["24047a86bc"] = "219.107.152",
    ["24047a86c0"] = "60.239.128",
    ["24047a86c4"] = "60.239.132",
    ["24047a86c8"] = "60.239.136",
    ["24047a86cc"] = "60.239.140",
    ["24047a86d0"] = "118.110.80",
    ["24047a86d4"] = "118.110.84",
    ["24047a86d8"] = "118.110.88",
    ["24047a86dc"] = "118.110.92",
    ["24047a86e0"] = "125.194.176",
    ["24047a86e4"] = "125.194.180",
    ["24047a86e8"] = "125.194.184",
    ["24047a86ec"] = "125.194.188",
    ["24047a86f0"] = "60.239.112",
    ["24047a86f4"] = "60.239.116",
    ["24047a86f8"] = "60.239.120",
    ["24047a86fc"] = "60.239.124",
    ["24047a8700"] = "125.195.56",
    ["24047a8704"] = "125.195.60",
    ["24047a8708"] = "125.196.32",
    ["24047a870c"] = "125.196.36",
    ["24047a8710"] = "118.108.80",
    ["24047a8714"] = "118.108.84",
    ["24047a8718"] = "118.111.80",
    ["24047a871c"] = "118.111.84",
    ["24047a8720"] = "218.227.176",
    ["24047a8724"] = "218.227.180",
    ["24047a8728"] = "60.239.208",
    ["24047a872c"] = "60.239.212",
    ["24047a8730"] = "118.109.56",
    ["24047a8734"] = "118.109.60",
    ["24047a8738"] = "122.131.88",
    ["24047a873c"] = "122.131.92",
    ["24047a8740"] = "122.131.96",
    ["24047a8744"] = "122.131.100",
    ["24047a8748"] = "122.130.48",
    ["24047a874c"] = "122.130.52",
    ["24047a8750"] = "125.198.224",
    ["24047a8754"] = "125.198.228",
    ["24047a8758"] = "119.243.104",
    ["24047a875c"] = "119.243.108",
    ["24047a8760"] = "118.109.152",
    ["24047a8764"] = "118.109.156",
    ["24047a8768"] = "118.111.104",
    ["24047a876c"] = "118.111.108",
    ["24047a8770"] = "119.239.48",
    ["24047a8774"] = "119.239.52",
    ["24047a8778"] = "122.130.16",
    ["24047a877c"] = "122.130.20",
    ["24047a8780"] = "125.196.128",
    ["24047a8784"] = "125.196.132",
    ["24047a8788"] = "122.131.48",
    ["24047a878c"] = "122.131.52",
    ["24047a8790"] = "122.134.104",
    ["24047a8794"] = "122.134.108",
    ["24047a8798"] = "60.238.208",
    ["24047a879c"] = "60.238.212",
    ["24047a87a0"] = "220.144.192",
    ["24047a87a4"] = "220.144.196",
    ["24047a87a8"] = "110.233.48",
    ["24047a87ac"] = "122.131.84",
    ["24047a87b0"] = "111.169.152",
    ["24047a87b4"] = "119.241.132",
    ["24047a87b8"] = "119.241.136",
    ["24047a87bc"] = "119.244.68",
    ["24047a87c0"] = "60.236.92",
    ["24047a87c4"] = "60.237.108",
    ["24047a87c8"] = "60.238.12",
    ["24047a87cc"] = "60.238.44",
    ["24047a87d0"] = "60.238.216",
    ["24047a87d4"] = "60.238.232",
    ["24047a87d8"] = "49.129.72",
    ["24047a87dc"] = "110.233.4",
    ["24047a87e0"] = "110.233.192",
    ["24047a87e4"] = "119.243.20",
    ["24047a87e8"] = "119.243.24",
    ["24047a87ec"] = "125.193.4",
    ["24047a87f0"] = "125.193.148",
    ["24047a87f4"] = "118.110.76",
    ["24047a87f8"] = "118.110.96",
    ["24047a87fc"] = "125.193.152"
}

local ruleprefix38_20 = {
    ["2400405000"] = "153.240.0",
    ["2400405004"] = "153.240.16",
    ["2400405008"] = "153.240.32",
    ["240040500c"] = "153.240.48",
    ["2400405010"] = "153.240.64",
    ["2400405014"] = "153.240.80",
    ["2400405018"] = "153.240.96",
    ["240040501c"] = "153.240.112",
    ["2400405020"] = "153.240.128",
    ["2400405024"] = "153.240.144",
    ["2400405028"] = "153.240.160",
    ["240040502c"] = "153.240.176",
    ["2400405030"] = "153.240.192",
    ["2400405034"] = "153.240.208",
    ["2400405038"] = "153.240.224",
    ["240040503c"] = "153.240.240",
    ["2400405040"] = "153.241.0",
    ["2400405044"] = "153.241.16",
    ["2400405048"] = "153.241.32",
    ["240040504c"] = "153.241.48",
    ["2400405050"] = "153.241.64",
    ["2400405054"] = "153.241.80",
    ["2400405058"] = "153.241.96",
    ["240040505c"] = "153.241.112",
    ["2400405060"] = "153.241.128",
    ["2400405064"] = "153.241.144",
    ["2400405068"] = "153.241.160",
    ["240040506c"] = "153.241.176",
    ["2400405070"] = "153.241.192",
    ["2400405074"] = "153.241.208",
    ["2400405078"] = "153.241.224",
    ["240040507c"] = "153.241.240",
    ["2400405080"] = "153.242.0",
    ["2400405084"] = "153.242.16",
    ["2400405088"] = "153.242.32",
    ["240040508c"] = "153.242.48",
    ["2400405090"] = "153.242.64",
    ["2400405094"] = "153.242.80",
    ["2400405098"] = "153.242.96",
    ["240040509c"] = "153.242.112",
    ["24004050a0"] = "153.242.128",
    ["24004050a4"] = "153.242.144",
    ["24004050a8"] = "153.242.160",
    ["24004050ac"] = "153.242.176",
    ["24004050b0"] = "153.242.192",
    ["24004050b4"] = "153.242.208",
    ["24004050b8"] = "153.242.224",
    ["24004050bc"] = "153.242.240",
    ["24004050c0"] = "153.243.0",
    ["24004050c4"] = "153.243.16",
    ["24004050c8"] = "153.243.32",
    ["24004050cc"] = "153.243.48",
    ["24004050d0"] = "153.243.64",
    ["24004050d4"] = "153.243.80",
    ["24004050d8"] = "153.243.96",
    ["24004050dc"] = "153.243.112",
    ["24004050e0"] = "153.243.128",
    ["24004050e4"] = "153.243.144",
    ["24004050e8"] = "153.243.160",
    ["24004050ec"] = "153.243.176",
    ["24004050f0"] = "153.243.192",
    ["24004050f4"] = "153.243.208",
    ["24004050f8"] = "153.243.224",
    ["24004050fc"] = "153.243.240",
    ["2400405100"] = "122.26.0",
    ["2400405104"] = "122.26.16",
    ["2400405108"] = "122.26.32",
    ["240040510c"] = "122.26.48",
    ["2400405110"] = "122.26.64",
    ["2400405114"] = "122.26.80",
    ["2400405118"] = "122.26.96",
    ["240040511c"] = "122.26.112",
    ["2400405120"] = "114.146.64",
    ["2400405124"] = "114.146.80",
    ["2400405128"] = "114.146.96",
    ["240040512c"] = "114.146.112",
    ["2400405130"] = "114.148.192",
    ["2400405134"] = "114.148.208",
    ["2400405138"] = "114.148.224",
    ["240040513c"] = "114.148.240",
    ["2400405140"] = "114.150.192",
    ["2400405144"] = "114.150.208",
    ["2400405148"] = "114.150.224",
    ["240040514c"] = "114.150.240",
    ["2400405150"] = "114.163.64",
    ["2400405154"] = "114.163.80",
    ["2400405158"] = "114.163.96",
    ["240040515c"] = "114.163.112",
    ["2400405180"] = "114.172.192",
    ["2400405184"] = "114.172.208",
    ["2400405188"] = "114.172.224",
    ["240040518c"] = "114.172.240",
    ["2400405190"] = "114.177.64",
    ["2400405194"] = "114.177.80",
    ["2400405198"] = "114.177.96",
    ["240040519c"] = "114.177.112",
    ["24004051a0"] = "118.0.64",
    ["24004051a4"] = "118.0.80",
    ["24004051a8"] = "118.0.96",
    ["24004051ac"] = "118.0.112",
    ["24004051b0"] = "118.7.64",
    ["24004051b4"] = "118.7.80",
    ["24004051b8"] = "118.7.96",
    ["24004051bc"] = "118.7.112",
    ["2400405200"] = "123.225.192",
    ["2400405204"] = "123.225.208",
    ["2400405208"] = "123.225.224",
    ["240040520c"] = "123.225.240",
    ["2400405210"] = "153.134.0",
    ["2400405214"] = "153.134.16",
    ["2400405218"] = "153.134.32",
    ["240040521c"] = "153.134.48",
    ["2400405220"] = "153.139.128",
    ["2400405224"] = "153.139.144",
    ["2400405228"] = "153.139.160",
    ["240040522c"] = "153.139.176",
    ["2400405230"] = "153.151.64",
    ["2400405234"] = "153.151.80",
    ["2400405238"] = "153.151.96",
    ["240040523c"] = "153.151.112",
    ["24004051c0"] = "118.8.192",
    ["24004051c4"] = "118.8.208",
    ["24004051c8"] = "118.8.224",
    ["24004051cc"] = "118.8.240",
    ["24004051d0"] = "118.9.0",
    ["24004051d4"] = "118.9.16",
    ["24004051d8"] = "118.9.32",
    ["24004051dc"] = "118.9.48",
    ["24004051e0"] = "123.218.64",
    ["24004051e4"] = "123.218.80",
    ["24004051e8"] = "123.218.96",
    ["24004051ec"] = "123.218.112",
    ["24004051f0"] = "123.220.128",
    ["24004051f4"] = "123.220.144",
    ["24004051f8"] = "123.220.160",
    ["24004051fc"] = "123.220.176",
    ["2400405240"] = "153.170.64",
    ["2400405244"] = "153.170.80",
    ["2400405248"] = "153.170.96",
    ["240040524c"] = "153.170.112",
    ["2400405250"] = "153.170.192",
    ["2400405254"] = "153.170.208",
    ["2400405258"] = "153.170.224",
    ["240040525c"] = "153.170.240",
    ["2400405260"] = "61.127.128",
    ["2400405264"] = "61.127.144",
    ["2400405268"] = "114.146.0",
    ["240040526c"] = "114.146.16",
    ["2400405270"] = "114.146.128",
    ["2400405274"] = "114.146.144",
    ["2400405278"] = "114.148.64",
    ["240040527c"] = "114.148.80",
    ["2400405280"] = "114.148.160",
    ["2400405284"] = "114.148.176",
    ["2400405288"] = "114.149.0",
    ["240040528c"] = "114.149.16",
    ["2400405290"] = "114.150.160",
    ["2400405294"] = "114.150.176",
    ["2400405298"] = "114.158.0",
    ["240040529c"] = "114.158.16",
    ["2400405160"] = "114.163.128",
    ["2400405164"] = "114.163.144",
    ["2400405168"] = "114.163.160",
    ["240040516c"] = "114.163.176",
    ["2400405170"] = "114.167.64",
    ["2400405174"] = "114.167.80",
    ["2400405178"] = "114.167.96",
    ["240040517c"] = "114.167.112",
    ["2400405300"] = "114.162.128",
    ["2400405304"] = "114.162.144",
    ["2400405308"] = "114.163.0",
    ["240040530c"] = "114.163.16",
    ["2400405310"] = "114.165.224",
    ["2400405314"] = "114.165.240",
    ["2400405318"] = "114.167.192",
    ["240040531c"] = "114.167.208",
    ["2400405320"] = "114.177.128",
    ["2400405324"] = "114.177.144",
    ["2400405328"] = "114.178.224",
    ["240040532c"] = "114.178.240",
    ["2400405330"] = "118.1.0",
    ["2400405334"] = "118.1.16",
    ["2400405338"] = "118.3.192",
    ["240040533c"] = "118.3.208",
    ["2400405340"] = "118.6.64",
    ["2400405344"] = "118.6.80",
    ["2400405348"] = "118.7.160",
    ["240040534c"] = "118.7.176",
    ["2400405360"] = "118.9.128",
    ["2400405364"] = "118.9.144",
    ["2400405368"] = "118.22.128",
    ["240040536c"] = "118.22.144",
    ["2400405370"] = "122.16.0",
    ["2400405374"] = "122.16.16",
    ["2400405378"] = "123.220.0",
    ["240040537c"] = "123.220.16",
    ["2400405350"] = "118.7.192",
    ["2400405354"] = "118.7.208",
    ["2400405358"] = "118.9.64",
    ["240040535c"] = "118.9.80",
    ["2400405380"] = "153.173.0",
    ["2400405384"] = "153.173.16",
    ["2400405388"] = "153.173.32",
    ["240040538c"] = "153.173.48",
    ["2400405390"] = "153.173.64",
    ["2400405394"] = "153.173.80",
    ["2400405398"] = "153.173.96",
    ["240040539c"] = "153.173.112",
    ["24004053a0"] = "153.173.128",
    ["24004053a4"] = "153.173.144",
    ["24004053a8"] = "153.173.160",
    ["24004053ac"] = "153.173.176",
    ["24004053b0"] = "153.173.192",
    ["24004053b4"] = "153.173.208",
    ["24004053b8"] = "153.173.224",
    ["24004053bc"] = "153.173.240",
    ["24004053c0"] = "153.238.0",
    ["24004053c4"] = "153.238.16",
    ["24004053c8"] = "153.238.32",
    ["24004053cc"] = "153.238.48",
    ["24004053d0"] = "153.238.64",
    ["24004053d4"] = "153.238.80",
    ["24004053d8"] = "153.238.96",
    ["24004053dc"] = "153.238.112",
    ["24004053e0"] = "153.238.128",
    ["24004053e4"] = "153.238.144",
    ["24004053e8"] = "153.238.160",
    ["24004053ec"] = "153.238.176",
    ["24004053f0"] = "153.238.192",
    ["24004053f4"] = "153.238.208",
    ["24004053f8"] = "153.238.224",
    ["24004053fc"] = "153.238.240",
    ["2400415000"] = "153.239.0",
    ["2400415004"] = "153.239.16",
    ["2400415008"] = "153.239.32",
    ["240041500c"] = "153.239.48",
    ["2400415010"] = "153.239.64",
    ["2400415014"] = "153.239.80",
    ["2400415018"] = "153.239.96",
    ["240041501c"] = "153.239.112",
    ["2400415020"] = "153.239.128",
    ["2400415024"] = "153.239.144",
    ["2400415028"] = "153.239.160",
    ["240041502c"] = "153.239.176",
    ["2400415030"] = "153.239.192",
    ["2400415034"] = "153.239.208",
    ["2400415038"] = "153.239.224",
    ["240041503c"] = "153.239.240",
    ["2400415040"] = "153.252.0",
    ["2400415044"] = "153.252.16",
    ["2400415048"] = "153.252.32",
    ["240041504c"] = "153.252.48",
    ["2400415050"] = "153.252.64",
    ["2400415054"] = "153.252.80",
    ["2400415058"] = "153.252.96",
    ["240041505c"] = "153.252.112",
    ["2400415060"] = "153.252.128",
    ["2400415064"] = "153.252.144",
    ["2400415068"] = "153.252.160",
    ["240041506c"] = "153.252.176",
    ["2400415070"] = "153.252.192",
    ["2400415074"] = "153.252.208",
    ["2400415078"] = "153.252.224",
    ["240041507c"] = "153.252.240",
    ["2400415080"] = "123.222.96",
    ["2400415084"] = "123.222.112",
    ["2400415088"] = "123.225.96",
    ["240041508c"] = "123.225.112",
    ["2400415090"] = "123.225.160",
    ["2400415094"] = "123.225.176",
    ["2400415098"] = "124.84.96",
    ["240041509c"] = "124.84.112",
    ["2400415380"] = "180.12.128",
    ["2400415384"] = "180.12.144",
    ["2400415388"] = "180.26.96",
    ["240041538c"] = "180.26.112",
    ["2400415390"] = "180.26.160",
    ["2400415394"] = "180.26.176",
    ["2400415398"] = "180.26.224",
    ["240041539c"] = "180.26.240",
    ["24004153a0"] = "180.30.0",
    ["24004153a4"] = "180.30.16",
    ["24004153a8"] = "180.31.96",
    ["24004153ac"] = "180.31.112",
    ["24004153c0"] = "180.46.0",
    ["24004153c4"] = "180.46.16",
    ["24004153c8"] = "180.48.0",
    ["24004153cc"] = "180.48.16",
    ["24004153d0"] = "180.50.192",
    ["24004153d4"] = "180.50.208",
    ["24004153d8"] = "180.53.0",
    ["24004153dc"] = "180.53.16",
    ["24004153b0"] = "180.32.64",
    ["24004153b4"] = "180.32.80",
    ["24004153b8"] = "180.34.160",
    ["24004153bc"] = "180.34.176",
    ["24004153e0"] = "218.230.128",
    ["24004153e4"] = "218.230.144",
    ["24004153e8"] = "219.161.64",
    ["24004153ec"] = "219.161.80",
    ["24004153f0"] = "220.96.64",
    ["24004153f4"] = "220.96.80",
    ["24004153f8"] = "220.99.0",
    ["24004153fc"] = "220.99.16",
    ["2400415100"] = "180.60.0",
    ["2400415104"] = "180.60.16",
    ["2400415108"] = "180.60.32",
    ["240041510c"] = "180.60.48",
    ["2400415110"] = "180.60.64",
    ["2400415114"] = "180.60.80",
    ["2400415118"] = "180.60.96",
    ["240041511c"] = "180.60.112",
    ["2400415120"] = "180.60.128",
    ["2400415124"] = "180.60.144",
    ["2400415128"] = "180.60.160",
    ["240041512c"] = "180.60.176",
    ["2400415130"] = "180.60.192",
    ["2400415134"] = "180.60.208",
    ["2400415138"] = "180.60.224",
    ["240041513c"] = "180.60.240",
    ["2400415140"] = "153.139.0",
    ["2400415144"] = "153.139.16",
    ["2400415148"] = "153.139.32",
    ["240041514c"] = "153.139.48",
    ["2400415150"] = "153.139.64",
    ["2400415154"] = "153.139.80",
    ["2400415158"] = "153.139.96",
    ["240041515c"] = "153.139.112",
    ["2400415160"] = "219.161.128",
    ["2400415164"] = "219.161.144",
    ["2400415168"] = "219.161.160",
    ["240041516c"] = "219.161.176",
    ["2400415170"] = "219.161.192",
    ["2400415174"] = "219.161.208",
    ["2400415178"] = "219.161.224",
    ["240041517c"] = "219.161.240",
    ["24004151c0"] = "124.84.128",
    ["24004151c4"] = "124.84.144",
    ["24004151c8"] = "124.98.192",
    ["24004151cc"] = "124.98.208",
    ["2400415180"] = "153.187.0",
    ["2400415184"] = "153.187.16",
    ["2400415188"] = "153.187.32",
    ["240041518c"] = "153.187.48",
    ["2400415190"] = "153.191.0",
    ["2400415194"] = "153.191.16",
    ["2400415198"] = "153.191.32",
    ["240041519c"] = "153.191.48",
    ["24004151a0"] = "180.12.64",
    ["24004151a4"] = "180.12.80",
    ["24004151a8"] = "180.12.96",
    ["24004151ac"] = "180.12.112",
    ["24004151b0"] = "180.13.0",
    ["24004151b4"] = "180.13.16",
    ["24004151b8"] = "180.13.32",
    ["24004151bc"] = "180.13.48",
    ["24004151d0"] = "124.100.0",
    ["24004151d4"] = "124.100.16",
    ["24004151d8"] = "124.100.224",
    ["24004151dc"] = "124.100.240",
    ["2400415300"] = "153.165.96",
    ["2400415304"] = "153.165.112",
    ["2400415308"] = "153.165.160",
    ["240041530c"] = "153.165.176",
    ["2400415310"] = "153.171.224",
    ["2400415314"] = "153.171.240",
    ["2400415318"] = "153.175.0",
    ["240041531c"] = "153.175.16",
    ["2400415344"] = "220.106.48",
    ["2400415374"] = "220.106.80",
    ["2400415340"] = "220.106.32",
    ["2400415370"] = "220.106.64",
    ["2400415320"] = "153.181.0",
    ["2400415324"] = "153.181.16",
    ["2400415328"] = "153.183.224",
    ["240041532c"] = "153.183.240",
    ["2400415330"] = "153.184.128",
    ["2400415334"] = "153.184.144",
    ["2400415338"] = "153.187.224",
    ["240041533c"] = "153.187.240",
    ["2400415360"] = "153.191.192",
    ["2400415364"] = "153.191.208",
    ["2400415348"] = "153.188.0",
    ["240041534c"] = "153.188.16",
    ["2400415350"] = "153.190.128",
    ["2400415354"] = "153.190.144",
    ["2400415358"] = "153.191.64",
    ["240041535c"] = "153.191.80",
    ["2400415368"] = "153.194.96",
    ["240041536c"] = "153.194.112",
    ["2400415200"] = "180.16.0",
    ["2400415204"] = "180.16.16",
    ["2400415208"] = "180.16.32",
    ["240041520c"] = "180.16.48",
    ["2400415210"] = "180.29.128",
    ["2400415214"] = "180.29.144",
    ["2400415218"] = "180.29.160",
    ["240041521c"] = "180.29.176",
    ["2400415220"] = "180.59.64",
    ["2400415224"] = "180.59.80",
    ["2400415228"] = "180.59.96",
    ["240041522c"] = "180.59.112",
    ["2400415230"] = "219.161.0",
    ["2400415234"] = "219.161.16",
    ["2400415238"] = "219.161.32",
    ["240041523c"] = "219.161.48",
    ["2400415250"] = "153.131.96",
    ["2400415254"] = "153.131.112",
    ["2400415260"] = "153.131.128",
    ["2400415264"] = "153.131.144",
    ["2400415268"] = "153.132.128",
    ["240041526c"] = "153.132.144",
    ["2400415240"] = "153.129.160",
    ["2400415244"] = "153.129.176",
    ["2400415248"] = "153.130.0",
    ["240041524c"] = "153.130.16",
    ["2400415270"] = "153.134.64",
    ["2400415274"] = "153.134.80",
    ["2400415278"] = "153.137.0",
    ["240041527c"] = "153.137.16",
    ["2400415280"] = "153.139.192",
    ["2400415284"] = "153.139.208",
    ["2400415288"] = "153.151.32",
    ["240041528c"] = "153.151.48",
    ["2400415290"] = "153.156.96",
    ["2400415294"] = "153.156.112",
    ["2400415298"] = "153.156.128",
    ["240041529c"] = "153.156.144"
}

-- WANインターフェースのIPv6アドレス（scope global）を取得
local function get_wan_ipv6_global()
    local command = "ip -6 addr show dev wan | awk '/inet6/ && /scope global/ {print $2}' | cut -d'/' -f1 | head -n 1"
    local ipv6_global = sys.exec(command)
    return ipv6_global:match("([a-fA-F0-9:]+)") -- IPv6アドレスの正規化
end

local wan_ipv6 = get_wan_ipv6_global()

-- Mape関連の数値を取得する関数、IPv6アドレスから対応するIPv4プレフィックスを取得
local function find_ipv4_prefix(wan_ipv6)
    local segments = {}
    for seg in wan_ipv6:gmatch("[a-fA-F0-9]+") do
        table.insert(segments, string.format("%04x", tonumber(seg, 16)))
    end

    local full_ipv6 = table.concat(segments, ":"):gsub("::", function(s)
        return ":" .. string.rep("0000:", 8 - #segments)
    end)

    -- 40ビットと32ビットのプレフィックスを取得
    local hex_prefix_40 = full_ipv6:gsub(":", ""):sub(1, 10)
    local hex_prefix_32 = full_ipv6:gsub(":", ""):sub(1, 8)

    local ipv4_prefix = ruleprefix38[hex_prefix_40] or ruleprefix38_20[hex_prefix_40] or ruleprefix31[hex_prefix_32]
    local ipv6_prefixlen

    if ipv4_prefix then
        local ipv4_parts = {}
        for part in ipv4_prefix:gmatch("(%d+)") do
            table.insert(ipv4_parts, part)
        end
        while #ipv4_parts < 4 do
            table.insert(ipv4_parts, "0")
        end

        -- 有効なプレフィックス長を判断
        if ruleprefix38[hex_prefix_40] or ruleprefix38_20[hex_prefix_40] then

                     -- ipv6prefixを32ビットもしくは48ビットセクションまで抽出し48ビットフォーマットの場合は00で埋める
                     local function extract_ipv6_prefix(wan_ipv6)
                                    -- IPv6アドレスを":"で分割
                                    local ipv6_sections = {}
                                    for section in wan_ipv6:gmatch("[^:]+") do
                                        table.insert(ipv6_sections, section)
                                    end
                                
                                    -- 先頭から48ビットを取り出し、最後の8ビットを00にする処理を正しく行う
                                    local prefix = ipv6_sections[1]
                                    if #ipv6_sections >= 3 then
                                        -- 3セクション目が存在する場合、先頭2セクションをそのまま使用し、3セクション目の先頭4ビット(16進数で2桁)を使用して00を追加
                                        local third_section = string.sub(ipv6_sections[3], 2, 1) -- 3セクション目の先頭4ビットを取得
                                        prefix = prefix .. ":" .. ipv6_sections[2] .. ":" .. third_section .. "00"
                                                    function hex_to_binary(hex_string)
                                                        local binary_string = ""
                                                        for i = 1, #hex_string do
                                                            local hex_digit = hex_string:sub(i, i)
                                                            local binary_digit = string.format("%04b", tonumber(hex_digit, 16))
                                                            binary_string = binary_string .. binary_digit
                                                        end
                                                        return binary_string
                                                    end            
                                        local binary_third_section = hex_to_binary(third_section)
                                        local ipv6_prefixlen = string.len(binary_third_section) + 32
                                    else
                                        -- 3セクション目が存在しない場合、先頭2セクションのみを使用
                                        prefix = prefix .. ":" .. ipv6_sections[2]
                                        local ipv6_prefixlen = '32'
                                    end
                                
                                    -- 3セクション目が"00"になった場合の処理は、具体的な例に基づいて調整が必要
                                    if prefix:find(":00") then
                                        -- 第3セクションが"00"の場合、省略可能なルールに従い調整
                                        prefix = prefix:gsub(":00", "")
                                    end                
                                    
                        -- 最後にプレフィックスの省略形を生成
                        return prefix .. "::", ipv6_prefixlen
                    end
            
                ipv6_prefix , ipv6_plefixlen = extract_ipv6_prefix(wan_ipv6)
                local third_octet = ipv4_prefix:match("^%d+%.%d+%.(%d+)") -- 第3セクションを抽出
                local binary = string.format("%b", tonumber(third_octet)) -- 2進数に変換
                ipv4_prefixlen = select(2, binary:gsub("0", "")):len() + 16 -- 1のビット数をカウントし、16を加える


            
        elseif ruleprefix31[hex_prefix_32] then
            ipv6_prefixlen = '32'
            ipv4_prefixlen = '16'
            ipv6_prefix = wan_ipv6:sub(1, 8) .. "::"
        end

        return table.concat(ipv4_parts, "."), ipv4_prefixlen, ipv6_prefix, ipv6_prefixlen
    else
        return nil, "No matching IPv4 prefix found."
    end
end







m = Map("ca_setup", "WAN接続設定", "下記のリストより適切なものを選んで実行してください。")

s = m:section(TypedSection, "ipoe", "")
s.addremove = false
s.anonymous = true

choice = s:option(ListValue, "wan_setup", "操作")
choice:value("dhcp_auto", "DHCP自動")
choice:value("pppoe_ipv4", "PPPoE接続")
choice:value("ipoe_v6plus", "v6プラス")
choice:value("ipoe_ocnvirtualconnect", "OCNバーチャルコネクト")
choice:value("ipoe_biglobe", "IPv6オプション")
choice:value("ipoe_transix", "transix")
choice:value("ipoe_xpass", "クロスパス")
choice:value("ipoe_v6connect", "v6コネクト")
choice:value("bridge_mode", "ブリッジモード")

-- PPPoEユーザー名とパスワード入力フォームの追加及び、選択された場合のみ、ユーザー名とパスワード欄を表示
username = s:option(Value, "username", "PPPoE ユーザー名")
password = s:option(Value, "password", "PPPoE パスワード")
password.password = true
username:depends("wan_setup", "pppoe_ipv4")
password:depends("wan_setup", "pppoe_ipv4")

-- インターフェース設定を削除する関数
local function deleteInterfaces()
    local interfaces = {"wan", "wan6", "wanmap", "pppoe_wan", "ds-lite", "map-e"}
    for _, interface in ipairs(interfaces) do
        uci:delete("network", interface)
    end
end

-- ds-lite接続設定関数
local function configure_dslite_connection(gw_aftr)
    -- DHCP LAN設定
    uci:set("dhcp", "lan", "dhcp")
    uci:set("dhcp", "lan", "ra", "relay")
    uci:set("dhcp", "lan", "dhcpv6", "server")
    uci:set("dhcp", "lan", "ndp", "relay")
    uci:set("dhcp", "lan", "force", "1")

    -- WAN設定の無効化
    uci:set("network", "wan", "auto", "0")

    -- DS-Liteインターフェースの設定
    uci:section("network", "interface", "dslite", {
        proto = 'dslite',
        peeraddr = gw_aftr, 
        tunlink = 'wan6',
        mtu = '1460'
    })

    -- DHCP関連設定
    uci:set("dhcp", "wan6", "dhcp")
    uci:set("dhcp", "wan6", "interface", "wan6")
    uci:set("dhcp", "wan6", "master", "1")
    uci:set("dhcp", "wan6", "ignore", "1")
    uci:set("dhcp", "wan6", "dhcpv6", "relay")
    uci:set("dhcp", "wan6", "ra", "relay")
    uci:set("dhcp", "wan6", "ndp", "relay")

    -- DS-LiteインターフェースをWANゾーンに追加
    uci:add_list("firewall", "@zone[1]", "network", "dslite")

    -- 設定のコミット
    uci:commit("dhcp")
    uci:commit("network")
    uci:commit("firewall")

end

-- map-e 接続設定関数
function configure_mape_connection(peeraddr, ipv4_prefix, ipv4_prefixlen, ipv6_prefix, ipv6_prefixlen, ealen, psidlen, offset)
    -- DHCP LAN settings
    uci:set("dhcp", "lan", "dhcp")
    uci:set("dhcp", "lan", "dhcpv6", "server")
    uci:set("dhcp", "lan", "ra", "relay")
    uci:set("dhcp", "lan", "ndp", "relay")
    uci:set("dhcp", "lan", "force", "1")

    -- WAN settings
    uci:set("network", "wan", "auto", "0")

    -- DHCP WAN6 settings
    uci:set("dhcp", "wan6", "dhcp")
    uci:set("dhcp", "wan6", "interface", "wan6")
    uci:set("dhcp", "wan6", "ignore", "1")
    uci:set("dhcp", "wan6", "master", "1")
    uci:set("dhcp", "wan6", "ra", "relay")
    uci:set("dhcp", "wan6", "dhcpv6", "relay")
    uci:set("dhcp", "wan6", "ndp", "relay")

    -- WANMAP settings
    uci:set("network", "wanmap", "interface")
    uci:set("network", "wanmap", "proto", "map")
    uci:set("network", "wanmap", "maptype", "map-e")
    uci:set("network", "wanmap", "peeraddr", peeraddr)
    uci:set("network", "wanmap", "ipaddr", ipv4_prefix)
    uci:set("network", "wanmap", "ip4prefixlen", ipv4_prefixlen)
    uci:set("network", "wanmap", "ip6prefix", ipv6_prefix .. "::")
    uci:set("network", "wanmap", "ip6prefixlen", ipv6_prefixlen)
    uci:set("network", "wanmap", "ealen", ealen)
    uci:set("network", "wanmap", "psidlen", psidlen)
    uci:set("network", "wanmap", "offset", offset)
    uci:set("network", "wanmap", "legacymap", "1")
    uci:set("network", "wanmap", "mtu", "1460")

    -- Firewall settings
    local ZONE_NO = "1"
    uci:delete("firewall", "@zone["..ZONE_NO.."]", "network", "wan")
    uci:add_list("firewall", "@zone["..ZONE_NO.."]", "network", "wan6")
    uci:add_list("firewall", "@zone["..ZONE_NO.."]", "network", "wanmap")

    uci:commit()
end

-- Biglobe用の東西peeraddr切り分け関数
local function set_peeraddr(wan_ipv6)
    local peeraddr
    local target_char = wan_ipv6:sub(9,9)
    if target_char then
        local num = tonumber(target_char, 16)
        if num >= 0 and num < 4 then
            peeraddr = "2001:260:700:1::1:275"
        elseif num >= 4 and num < 8 then
            peeraddr = "2001:260:700:1::1:276"
        end
    end
    return peeraddr
end


--デバッグ表示用
local wan_ipv6 = "2400:4053:6407::" -- これはデバッグ用なので確認が済んだら消す必要があります。
local ipv4_prefix, ipv4_prefixlen, ipv6_prefix, ipv6_prefixlen = find_ipv4_prefix(wan_ipv6)
local ealen = "EA長" -- 実際のEA長を計算または取得する処理を追加
local psidlen = "PSID長" -- 実際のPSID長を計算または取得する処理を追加
local offset = "オフセット" -- 実際のオフセットを計算または取得する処理を追加

local peeraddr = set_peeraddr(wan_ipv6)

o = s:option(DummyValue, "wan_ipv6", translate("WAN IPv6 Address"))
o.value = wan_ipv6 or translate("Not available")

o = s:option(DummyValue, "ipv4_prefix", translate("MAPE IPv4 Prefix"))
o.value = ipv4_prefix or translate("No matching IPv4 prefix found.")

o = s:option(DummyValue, "ipv4_prefixlen", translate("IPv4 Prefix Length"))
o.value = ipv4_prefixlen or translate("Not available")

o = s:option(DummyValue, "ipv6_prefixlen", translate("IPv6 Prefix Length"))
o.value = ipv6_prefixlen or translate("Not available")

o = s:option(DummyValue, "ipv6_prefix", translate("IPv6 Prefix"))
o.value = ipv6_prefix

o = s:option(DummyValue, "ealen", translate("EA Length"))
o.value = ealen

o = s:option(DummyValue, "psidlen", translate("PSID Length"))
o.value = psidlen

o = s:option(DummyValue, "offset", translate("Offset"))
o.value = offset

o = s:option(DummyValue, "peeraddr", translate("peeraddr"))
o.value = peeraddr or translate("No matching IPv4 prefix found.")




--ここまで



-- LuciのSAVE＆APPLYボタンが押された時の動作
function m.on_commit(map)
    local choice_val = m.uci:get("ca_setup", "ipoe", "wan_setup")
    local gw_aftr = m.uci:get("ca_setup", choice_val, "gw_aftr")
    --既存のWAN設定を削除
    deleteInterfaces()
    
    if choice_val == "dhcp_auto" then

        -- DHCP自動設定を適用
        uci:set("network", "wan", "interface")
        uci:set("network", "wan", "proto", "dhcp")
        uci:set("network", "wan6", "interface")
        uci:set("network", "wan6", "proto", "dhcpv6")
        uci:set("network", "wan6", "reqaddress", "try")
        uci:set("network", "wan6", "reqprefix", "auto")
        uci:commit("network")
                
    elseif choice_val == "pppoe_ipv4" then
        
        -- PPPoE設定を適用
        local user = m.uci:get("ca_setup", "ipoe", "username")
        local pass = m.uci:get("ca_setup", "ipoe", "password")
        uci:set("network", "pppoe_wan", "interface")
        uci:set("network", "pppoe_wan", "proto", "pppoe")
        uci:set("network", "pppoe_wan", "username", user)
        uci:set("network", "pppoe_wan", "password", pass)
        uci:set("network", "pppoe_wan", "ifname", "eth0.2")
        uci:add_list("firewall", "@zone[1]", "network", "pppoe_wan")
        uci:commit("network")
        uci:commit("firewall")
        
    elseif choice_val == "ipoe_v6plus" then
       
        -- v6プラス
          local peeraddr = "2404:9200:225:100::64"
        -- 関数を呼び出して設定を適用
        configure_mape_connection(peeraddr, ipv4_prefix, ipv4_prefixlen, ipv6_prefix, ipv6_prefixlen, ealen, psidlen, offset)
        -- ここにいれる
    
    elseif choice_val == "ipoe_ocnvirtualconnect" then
        
        -- OCNバーチャルコネクト
           local peeraddr = "2001:380:a120::9"
        -- ここにいれる

    elseif choice_val == "ipoe_biglobe" then
        
        -- BIGLOBE IPv6オプション
           local peeraddr = set_peeraddr(wan_ipv6)
        -- ここにいれる
        
    elseif choice_val == "ipoe_transix" then
        -- transix (ds-lite)
           configure_dslite_connection(gw_aftr)
    
    elseif choice_val == "ipoe_xpass" then
        -- クロスパス (ds-lite)
           configure_dslite_connection(gw_aftr)
        
    elseif choice_val == "ipoe_v6connect" then
        -- v6コネクト
           configure_dslite_connection(gw_aftr)
        
    elseif choice_val == "bridge_mode" then
        -- ブリッジモード設定の適用
        -- uci:set("network", "lan", "type", "bridge")
        -- uci:set("network", "lan", "ifname", "eth0.1 eth0.2")  -- 例としてeth0.1とeth0.2をブリッジ
        -- uci:delete("network", "lan", "proto")  -- DHCPなどの既存設定を削除
        -- uci:commit("network")
    end

    -- ネットワークサービス、DHCPサービス、ファイアウォールの再起動
    os.execute("/etc/init.d/network restart")
    os.execute("/etc/init.d/dnsmasq restart")
    os.execute("/etc/init.d/firewall restart")

end

return m
